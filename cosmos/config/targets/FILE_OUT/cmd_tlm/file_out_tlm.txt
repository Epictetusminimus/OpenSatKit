<% 
  require 'fsw_config_param'
  require 'fsw_const'
  require 'osk_config' 
  require 'osk_global'

  @APP_PREFIX_STR = "FILE_OUT"
  @HK_TLM_MID_STR = "FILE_OUT_HK_TLM_MID"  
  
  @START_TRANSFER_TLM_MID_STR  = "FILE_OUT_START_TRANSFER_TLM_MID"  
  @DATA_SEGMENT_TLM_MID_STR    = "FILE_OUT_DATA_SEGMENT_TLM_MID"  
  @FINISH_TRANSFER_TLM_MID_STR = "FILE_OUT_FINISH_TRANSFER_TLM_MID"  
  
  # Configuration parameter assumptions
  #   OS_MAX_PATH_LEN = 64
  #   OS_MAX_API_NAME = 20
  
%>

TELEMETRY <%= @APP_PREFIX_STR %> <%= Osk::TLM_STR_HK_PKT %> <%= Osk::Cfg.processor_endian %> "Housekeeping telemetry packet"
  <%= Osk::Cfg.tlm_hdr(@APP_PREFIX_STR, @HK_TLM_MID_STR) %>
  APPEND_ITEM <%= Osk::TLM_STR_CMD_VLD %> 16 UINT "Application command counter"
  APPEND_ITEM <%= Osk::TLM_STR_CMD_ERR %> 16 UINT "Application command error counter"
  APPEND_ITEM FILE_TRANSFER_CNT       8 UINT "Number of complete file transfers"
  APPEND_ITEM FILE_TRANSFER_STATE     8 UINT "Boolean indicating if file transfer active"
    STATE UNDEF     0
    STATE IDLE      1
    STATE START     2
    STATE SEND_DATA 3
    STATE FINISHED  4
    STATE PAUSED    5
  APPEND_ITEM PAUSED_TRANSFER_STATE   8 UINT "Boolean indicating if file transfer active"
    STATE UNDEF     0
    STATE IDLE      1
    STATE START     2
    STATE SEND_DATA 3
    STATE FINISHED  4
    STATE PAUSED    5
  APPEND_ITEM PREV_SEGMENT_FAILED     8 UINT "Boolean indicating if last segment not sent in tlm"
    STATE FALSE 0
    STATE TRUE  1 RED
  APPEND_ITEM FILE_TRANSFER_BYTE_CNT 32 UINT "Number of file data bytes sent"
  APPEND_ITEM FILE_RUNNING_CRC       32 UINT "Running CRC of file data sent"
  APPEND_ITEM DATA_TRANSFER_LEN      32 UINT ""
  APPEND_ITEM FILE_LEN               32 UINT ""
  APPEND_ITEM FILE_BYTE_OFFSET       32 UINT "DataSegmentOffset*DataSegmentLen"
  APPEND_ITEM DATA_SEGMENT_LEN       16 UINT "Length in start transfer command"
  APPEND_ITEM DATA_SEGMENT_OFFSET    16 UINT "Starting data segment"
  APPEND_ITEM NEXT_DATA_SEGMENT_ID   16 UINT ""
  APPEND_ITEM SRC_FILENAME          512 STRING "Source Pathname/Filename"


TELEMETRY <%= @APP_PREFIX_STR %> START_TRANSFER_PKT <%= Osk::Cfg.processor_endian %> "Start file transfer"
  <%= Osk::Cfg.tlm_hdr(@APP_PREFIX_STR, @START_TRANSFER_TLM_MID_STR) %>
  APPEND_ITEM DATA_LEN       32 UINT "Either file length or file length minus commanded segment offset"
  APPEND_ITEM SRC_FILENAME  512 STRING "Source Pathname/Filename"
  
TELEMETRY <%= @APP_PREFIX_STR %> DATA_SEGMENT_PKT <%= Osk::Cfg.processor_endian %> "Data segment"
  <%= Osk::Cfg.tlm_hdr(@APP_PREFIX_STR, @DATA_SEGMENT_TLM_MID_STR) %>
  APPEND_ITEM ID     16 UINT ""
  APPEND_ITEM LEN    16 UINT ""
  APPEND_ITEM DATA  512 BLOCK ""

TELEMETRY <%= @APP_PREFIX_STR %> FINISH_TRANSFER_PKT <%= Osk::Cfg.processor_endian %> "Finish file transfer"
  <%= Osk::Cfg.tlm_hdr(@APP_PREFIX_STR, @FINISH_TRANSFER_TLM_MID_STR) %>
  APPEND_ITEM FILE_LEN             32 UINT "Total file length"
  APPEND_ITEM FILE_CRC             32 UINT "Final CRC of file data sent"
  APPEND_ITEM LAST_DATA_SEGMENT_ID 16 UINT "ID of last data segment sent"
